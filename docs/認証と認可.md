# 認証と認可の違い

## 辞書的な意味

認証とは，**対象の正当性や真正性を確かめること**．IT の分野では，相手が名乗った通りの本人であると何らかの手段（id, password）により確かめる本人確認（相手認証）のことを単に認証ということが多い．データが改竄されていないか確かめたり（メッセージ認証など）、データの属性が真正であることを確認すること（時刻認証など）を指す場合もある。

## 基本的な流れ

基本的には，

- 認証 -> 認可

の順．

1. **認証**：アクセスしてきたユーザの正当性（ID やパスワードなど）を確認する．
2. **認可**：認証されたユーザに対してそのサーバ上での特定の権限（API へのアクセス権など）を与える．

## 2 者間認証：Authenticate

- 証明する，認証する．
- システム主体によって / システム主体について，主張された身元を検証すること．
- 認証する側とされる側が事前に共有している情報を確認すること．

例えば，サーバにユーザ ID，パスワードを登録しておいてログイン時にそれを提示してサーバ側に保存された ID，パスワードと照らし合わせて認証する．

## 3 者間認証：Certification

- 信頼できる機関（認証局）が発行した証明書を元に，「持ち主」の正当性を確認すること．

## 認可：Authorization

認証済みの利用者に対し，アクセス権の設定などを参照して，**本人に与えられた適切な権限による操作を許可する（権限外の利用を拒否する）**ことを「認可」と呼び，英語では "authorization"（オーソライゼーション）という．

認証の次の段階で行われる権限の付与のことを指すが，**単純なシステムでは認証と同時に認可も済んでしまうことも多く**，字面も似ており、日常的な語彙としては似た意味合いであるため、しばしば混同される．認証向けの技術を認可に用いるといった不適切な事例も起きている．

英語でも “authentication” と “authorization” は日常語彙としては意味も綴りも似ており、日本語の場合と事情は近い。さらに、方式名や製品名に使用する際などに、どちらも “auth” と略されることがあるため、余計に混同しやすいという事情があり、近年では認証を “authn” 、認可を “authz” として別の略号を用いることが提唱されている。

## API を守る仕組み：OAuth 2.0

- ユーザのデータがあり，それを管理するサーバを「リソースサーバ」
- ユーザのデータを利用したい「クライアント（アプリケーション）」がある
- リソースサーバでは，データを利用したいクライアントのためにデータをやりとりする口を用意する．これが「API」である．
- クライアントがリソースサーバに対してデータを要求すると，リソースサーバは API を介してクライアントへデータを渡す．
- 悪意のあるユーザでも渡してしまう．-> **API を守る仕組みが必要**．

- アクセストークン：クライアントアプリケーションがリソースを利用することを許可されていることを示すもの．アクセストークンを発行するサーバを「認可サーバ」という．アクセストークンはリソースサーバに持たせておく必要があるため，アクセストークンをまず発行するところから始める（リソースサーバへのユーザ登録のようなもの）．OAuth 2.0 は，**アクセストークンの要求方法とそれに対する応答方法を標準化したもの**．

- Web 連携を行うサービスが増加し、それぞれの API を公開して共有するため、API アクセスを認可する手段が必要とされたこと

## アクセストークンと認可サーバ

Web サービスを利用していると、ユーザーが持つデータを**別のアプリケーションで再利用したい**場合が出てきます。

この場合、**別のアプリケーションがユーザーの持つデータを保管しているサービスに、データの利用をリクエストします**。このリクエストを受けるのがサービスの「認可サーバ」です。

例えば，togetter が twitter のデータへのアクセス権をリクエストする．

認可サーバはリクエストに対し、アクセスを許可する認可情報であるアクセストークンの発行をして良いかユーザーに確認し、確認が取れればアプリケーションにアクセストークンを発行します。

## OAuth は完全に信頼しない

OAuth は，Web サービス間の認証を行い，共有を簡単にするプロトコルだが，**ユーザーの認証を行うために設計されたプロトコルではありません**。（認証と認可は違うよ！！）認可はリソースへのアクセス許可を出す以上でも以下でもない．

API アクセス権譲渡をされたクライアントアプリが取得・保持したユーザー情報が流出し、アカウントの乗っ取りなどが起こってしまうのはこのためです。

このような認証の脆弱性を理解せずに、OAuth を実装している Web サービスやアプリケーションも多く、中には OAuth 1.0 を実装したため、大量のユーザーデータが流出してしまったという事例もあります。

これを回避するためには、ユーザーが OAuth の機能や用途を正確に理解し、安易に OAuth による API アクセス権譲渡を許可しないことが重要です。

- 認証：通信の相手が誰（何）であるかを確認すること
- 認可：とある特定の条件に対して，リソースアクセスの権限を与えること．

認証と認可は密接に絡み合っている一方で全く別の概念です。正直、理解は簡単ではないと思います。

まず「認証」は英語では Authentication と言います。長いので略して AuthN と書いたりすることもあります。意味としては 通信の相手が誰（何）であるかを確認すること を表します。**純粋な「認証」を考えるにあたっては「リソース」やそれに対する「権限」という概念は登場しません**。

一方「認可」は英語では Authorization と言います。略して AuthZ（AuthR と書く場合もあるらしいです）です。意味としては とある特定の条件に対して、リソースアクセスの権限を与えること を表します。**純粋な「認可」には、「誰」という考え方はありません**。

- 純粋な「認証」には「リソース」，「リソースに対する権限」という概念は登場しない．

- 純粋な「認可」には，「誰がリソースへアクセスしてよいか」の「誰」という考え方はない．

## 非対称な並列比較に注意

さて、以上が認証と認可の切り分けに関する解説です。

ここまで比較しておいてアレなんですが、認証と認可というのは相互に比較するにあたって「対称性」が無いと思っています。

先ほど、認証は証明書、認可は鍵、というメタファを示しました。これらのメタファは「発行」と「検証」という段階があると思います。

認証というのは、証明書発行の瞬間ではなく、提示された証明書を検証する瞬間のことを言います。

一方で、認可というのは、鍵発行の瞬間（正確に言えば、アクセスポリシー定義段階）のことを示しており、提示された鍵を検証するタイミング（アクセスポリシー施行段階）を指すわけではありません。

難しいですね。。。